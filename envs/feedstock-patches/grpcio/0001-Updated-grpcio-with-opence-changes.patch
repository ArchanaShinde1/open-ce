From d164f6e0094744b01e4cc871f5b4a11cac6c1451 Mon Sep 17 00:00:00 2001
From: Nishidha Panpaliya <npanpa23@in.ibm.com>
Date: Fri, 11 Aug 2023 12:49:47 -0400
Subject: [PATCH] Updated grpcio 1.54 with open-ce changes

---
 recipe/0001-Fix-openssl-for-s390x.patch | Bin 0 -> 783 bytes
 recipe/build.sh                         |  19 +++++++++----
 recipe/meta.yaml                        |  34 ++++++++++++------------
 3 files changed, 31 insertions(+), 22 deletions(-)
 create mode 100644 recipe/0001-Fix-openssl-for-s390x.patch

diff --git a/recipe/0001-Fix-openssl-for-s390x.patch b/recipe/0001-Fix-openssl-for-s390x.patch
new file mode 100644
index 0000000000000000000000000000000000000000..c29467f10dbd7eb8efd964d34b35cd5eed403f8e
GIT binary patch
literal 783
zcmaJ<%WfJm6y5tPj>sm_Fz+D*R8>$C)JkcKO0ue|kso)!?O-F1M}XRouOZ!ZgJsFS
zzQ^Z2&RsgY!&r)(cqs}|HI$7W1kZ|wk7TB*d@>qWa>7M3Rsx@`!J78S$H=njWuwTl
zoGk;*6puuE-fAqiws*YK9Pd<klG~!3X_IKNOQhYsXOG;|6icUv$aBp5O&}>s<kfUk
zPDcfzEG)L}#ZQucitnrW%i`k?EcFp~Pp0cyG}fUjC)ts)IF1=QCsS=?+bc@{VN$_6
zO1Aiez!)Go8r>4)mYWT!5E|Na<h-`#Ho808idwpu@f~AIHx1%=qdj<fg<f27GHnzc
z!E;`f*@Ra~@}R{1qzKJMo@Mt{b<X}OKZ~LWS7Xd(i1Q*JjuE{b;en2xoWWo*z;A{$
zMXSAUDJG*dH{ecgwGYkh9d!woy^-g-I~;V|!dQ>Jv#OT_zYQI;&IK&E=?>&BbYTu`
za0Lxcou^&k_|}^@usiL&tvz)fLL2T*!!scl?dkGUUi@j8gMCoLU4V&{LkJ3*61Y;@
zY`|gY@L!$@i*Lxep!?v}{4(|s;&HbjkHzYBz@i&PjW&d@tEVsP^>ck+)gL~+Fx;GL
gZWzK%H$mbvNZr=;e6@Ohs_VO;09cWfRgyFI7v)&?od5s;

literal 0
HcmV?d00001

diff --git a/recipe/build.sh b/recipe/build.sh
index f797569..4b683f5 100644
--- a/recipe/build.sh
+++ b/recipe/build.sh
@@ -1,12 +1,23 @@
 #!/bin/bash
 
+set -exou
 export GRPC_BUILD_WITH_BORING_SSL_ASM=""
-export GRPC_PYTHON_BUILD_SYSTEM_ZLIB="True"
-export GRPC_PYTHON_BUILD_SYSTEM_OPENSSL="True"
-export GRPC_PYTHON_BUILD_SYSTEM_CARES="True"
+export GRPC_PYTHON_BUILD_SYSTEM_ZLIB="False"
+export GRPC_PYTHON_BUILD_SYSTEM_OPENSSL="False"
+export GRPC_PYTHON_BUILD_SYSTEM_CARES="False"
 export GRPC_PYTHON_USE_PREBUILT_GRPC_CORE=""
 export GRPC_PYTHON_BUILD_WITH_CYTHON="True"
 
+ARCH=$(uname -m)
+if [[ $ARCH == "s390x" || $ARCH == "ppc64le" ]]; then
+    echo "Patching boringssl"
+    CURPWD=$(pwd)
+    cd $SRC_DIR/third_party/boringssl-with-bazel
+    git apply ${RECIPE_DIR}/0001-Fix-openssl-for-s390x.patch
+    echo "Done with patching"
+    cd $CURPWD
+fi
+
 if [[ "${target_platform}" == linux-* ]]; then
     # set these so the default in setup.py are not used
     # it seems that we need to link to pthrad on linux or osx.
@@ -20,6 +31,4 @@ if [[ "$target_platform" == osx-64 ]]; then
 fi
 
 ln -s "$(which $CC)" "$SRC_DIR/cc"
-export PATH="$SRC_DIR:$PATH"
-
 $PYTHON -m pip install . --no-deps --ignore-installed --no-cache-dir -vvv
diff --git a/recipe/meta.yaml b/recipe/meta.yaml
index 19fa19a..ee9aa1c 100644
--- a/recipe/meta.yaml
+++ b/recipe/meta.yaml
@@ -1,17 +1,17 @@
-{% set version = "1.46.3" %}
+{% set version = "1.54.3" %}
 
 package:
   name: grpcio
   version: {{ version }}
 
 source:
-  url: https://pypi.io/packages/source/g/grpcio/grpcio-{{ version }}.tar.gz
-  sha256: 4b8fd8b1cd553635274b83cd984f0755e6779886eca53c1c71d48215962eb689
+  git_url: https://github.com/grpc/grpc
+  git_rev: v{{ version }}
   patches:
     - 0001-Monkey-patch-distutils.ccompiler.spawn-to-elide-std-.patch
-    - 0002-windows-ssl-lib-names.patch
-    - 0001-fix-win-setup.patch
-    - 0001-fix-win-commands.patch
+    - 0002-windows-ssl-lib-names.patch   #[win]
+    - 0001-fix-win-setup.patch           #[win]
+    - 0001-fix-win-commands.patch        #[win]
 
 build:
   number: 0
@@ -19,27 +19,27 @@ build:
 
 requirements:
   build:
-    - python                                 # [build_platform != target_platform]
+    - python {{ python }}                               # [build_platform != target_platform]
     - cross-python_{{ target_platform }}     # [build_platform != target_platform]
     - cython                                 # [build_platform != target_platform]
     - {{ compiler('c') }}
     - {{ compiler('cxx') }}
   host:
-    - python
+    - python {{ python }}
     - pip
-    - setuptools
+    - setuptools {{ setuptools }}
     - cython
-    - six >=1.6.0
-    - zlib
-    - openssl
+    - six {{ six }}
+    - zlib {{ zlib }}
+    - openssl 3.*
     - c-ares            # [unix]
     - pthread-stubs     # [linux]
   run:
-    - python
-    - setuptools
-    - six >=1.6.0
-    - zlib
-    - openssl
+    - python {{ python }}
+    - setuptools {{ setuptools }}
+    - six {{ six }}
+    - zlib {{ zlib }}
+    - openssl 3.*
     - {{ pin_compatible("c-ares") }}  # [unix]
     - __osx >={{ MACOSX_DEPLOYMENT_TARGET|default("10.9") }}  # [osx and x86_64]
 
-- 
2.27.0

