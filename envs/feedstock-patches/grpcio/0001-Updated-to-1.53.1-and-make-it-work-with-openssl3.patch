From 99073ff6cac938dc365422b6f4ede3797f8e1f2a Mon Sep 17 00:00:00 2001
From: Nishidha Panpaliya <npanpa23@in.ibm.com>
Date: Fri, 28 Jul 2023 11:32:31 +0000
Subject: [PATCH] Fixed grpcio with openssl 3

---
 .../0001-Make-grpc-work-with-openssl-3.patch  | 48 +++++++++++++++++++
 recipe/build.sh                               | 10 ++--
 recipe/meta.yaml                              | 35 +++++++-------
 3 files changed, 72 insertions(+), 21 deletions(-)
 create mode 100644 recipe/0001-Make-grpc-work-with-openssl-3.patch

diff --git a/recipe/0001-Make-grpc-work-with-openssl-3.patch b/recipe/0001-Make-grpc-work-with-openssl-3.patch
new file mode 100644
index 0000000..2f39549
--- /dev/null
+++ b/recipe/0001-Make-grpc-work-with-openssl-3.patch
@@ -0,0 +1,48 @@
+From 083e8b127679e415b99bff289ae74b124c0082fb Mon Sep 17 00:00:00 2001
+From: Nishidha Panpaliya <npanpa23@in.ibm.com>
+Date: Fri, 28 Jul 2023 10:17:16 +0000
+Subject: [PATCH] Make grpc work with openssl 3
+
+---
+ Makefile | 1 -
+ setup.py | 5 +++--
+ 2 files changed, 3 insertions(+), 3 deletions(-)
+
+diff --git a/Makefile b/Makefile
+index 1ac3f6b058..bb8678bcda 100644
+--- a/Makefile
++++ b/Makefile
+@@ -568,7 +568,6 @@ OPENSSL_DEP += $(LIBDIR)/$(CONFIG)/libboringssl.a
+ OPENSSL_MERGE_LIBS += $(LIBDIR)/$(CONFIG)/libboringssl.a
+ OPENSSL_MERGE_OBJS += $(LIBBORINGSSL_OBJS)
+ # need to prefix these to ensure overriding system libraries
+-CPPFLAGS := -Ithird_party/boringssl-with-bazel/src/include $(CPPFLAGS)  
+ ifeq ($(DISABLE_ALPN),true)
+ CPPFLAGS += -DTSI_OPENSSL_ALPN_SUPPORT=0
+ LIBS_SECURE = $(OPENSSL_LIBS)
+diff --git a/setup.py b/setup.py
+index 8da207b713..e7239f21bd 100644
+--- a/setup.py
++++ b/setup.py
+@@ -69,8 +69,6 @@ if 'linux' in sys.platform:
+ if 'openbsd' in sys.platform:
+     CARES_INCLUDE += (os.path.join('third_party', 'cares', 'config_openbsd'),)
+ RE2_INCLUDE = (os.path.join('third_party', 're2'),)
+-SSL_INCLUDE = (os.path.join('third_party', 'boringssl-with-bazel', 'src',
+-                            'include'),)
+ UPB_INCLUDE = (os.path.join('third_party', 'upb'),)
+ UPB_GRPC_GENERATED_INCLUDE = (os.path.join('src', 'core', 'ext',
+                                            'upb-generated'),)
+@@ -308,6 +306,9 @@ if BUILD_WITH_SYSTEM_ABSL:
+                           CORE_C_FILES)
+     ABSL_INCLUDE = (os.path.join('/usr', 'include'),)
+ 
++
++SSL_INCLUDE = (os.environ.get("SSL_INC", ""),
++                os.path.join('third_party', 'boringssl-with-bazel', 'src', 'include'))
+ EXTENSION_INCLUDE_DIRECTORIES = ((PYTHON_STEM,) + CORE_INCLUDE + ABSL_INCLUDE +
+                                  ADDRESS_SORTING_INCLUDE + CARES_INCLUDE +
+                                  RE2_INCLUDE + SSL_INCLUDE + UPB_INCLUDE +
+-- 
+2.40.1
+
diff --git a/recipe/build.sh b/recipe/build.sh
index f797569..8d90821 100644
--- a/recipe/build.sh
+++ b/recipe/build.sh
@@ -1,11 +1,12 @@
 #!/bin/bash
 
 export GRPC_BUILD_WITH_BORING_SSL_ASM=""
-export GRPC_PYTHON_BUILD_SYSTEM_ZLIB="True"
-export GRPC_PYTHON_BUILD_SYSTEM_OPENSSL="True"
-export GRPC_PYTHON_BUILD_SYSTEM_CARES="True"
+export GRPC_PYTHON_BUILD_SYSTEM_ZLIB="False"
+export GRPC_PYTHON_BUILD_SYSTEM_OPENSSL="False"
+export GRPC_PYTHON_BUILD_SYSTEM_CARES="False"
 export GRPC_PYTHON_USE_PREBUILT_GRPC_CORE=""
 export GRPC_PYTHON_BUILD_WITH_CYTHON="True"
+export SSL_INC="$PREFIX/include"
 
 if [[ "${target_platform}" == linux-* ]]; then
     # set these so the default in setup.py are not used
@@ -21,5 +22,6 @@ fi
 
 ln -s "$(which $CC)" "$SRC_DIR/cc"
 export PATH="$SRC_DIR:$PATH"
-
+export CPPFLAGS="-I${PREFIX}/include $CPPFLAGS -DOPENSSL_NO_DEPRECATED=0 -DOPENSSL_X509_H=1"
+export LDFLAGS="$LDFLAGS -L${PREFIX}/lib"
 $PYTHON -m pip install . --no-deps --ignore-installed --no-cache-dir -vvv
diff --git a/recipe/meta.yaml b/recipe/meta.yaml
index 19fa19a..79f4fbe 100644
--- a/recipe/meta.yaml
+++ b/recipe/meta.yaml
@@ -1,17 +1,18 @@
-{% set version = "1.46.3" %}
+{% set version = "1.53.1" %}
 
 package:
   name: grpcio
   version: {{ version }}
 
 source:
-  url: https://pypi.io/packages/source/g/grpcio/grpcio-{{ version }}.tar.gz
-  sha256: 4b8fd8b1cd553635274b83cd984f0755e6779886eca53c1c71d48215962eb689
+  git_url: https://github.com/grpc/grpc
+  git_rev: v{{ version }}
   patches:
     - 0001-Monkey-patch-distutils.ccompiler.spawn-to-elide-std-.patch
-    - 0002-windows-ssl-lib-names.patch
-    - 0001-fix-win-setup.patch
-    - 0001-fix-win-commands.patch
+    - 0002-windows-ssl-lib-names.patch   #[win]
+    - 0001-fix-win-setup.patch           #[win]
+    - 0001-fix-win-commands.patch        #[win]
+    - 0001-Make-grpc-work-with-openssl-3.patch
 
 build:
   number: 0
@@ -19,27 +20,27 @@ build:
 
 requirements:
   build:
-    - python                                 # [build_platform != target_platform]
+    - python {{ python }}                               # [build_platform != target_platform]
     - cross-python_{{ target_platform }}     # [build_platform != target_platform]
     - cython                                 # [build_platform != target_platform]
     - {{ compiler('c') }}
     - {{ compiler('cxx') }}
   host:
-    - python
+    - python {{ python }}
     - pip
-    - setuptools
+    - setuptools {{ setuptools }}
     - cython
-    - six >=1.6.0
-    - zlib
-    - openssl
+    - six {{ six }}
+    - zlib {{ zlib }}
+    - openssl 3.*
     - c-ares            # [unix]
     - pthread-stubs     # [linux]
   run:
-    - python
-    - setuptools
-    - six >=1.6.0
-    - zlib
-    - openssl
+    - python {{ python }}
+    - setuptools {{ setuptools }}
+    - six {{ six }}
+    - zlib {{ zlib }}
+    - openssl 3.*
     - {{ pin_compatible("c-ares") }}  # [unix]
     - __osx >={{ MACOSX_DEPLOYMENT_TARGET|default("10.9") }}  # [osx and x86_64]
 
-- 
2.40.1

